collection:

  # Route
  # AWS ECS ping
  - pattern: "/ssr/sitemap.xml"
    pipeline:
      - type: process
        cmd: >
          node
          --experimental-modules
          --no-warnings
          --experimental-vm-modules
          ./sitemap.mjs
          --output=stdout
          --origin=https://jetsmarter.com/
          --src=https://jetsmarter.com/data/jscomv5/index.es.js
        # --src=https://d35qz7xn7nfid5.cloudfront.net/ssr/index.es.js

      - type: plugin
        path: ./ssr-Linux-x86_64.so
        name: JsonEntrypoint


  - pattern: "/ssr/{url:*}"
    pipeline:

      # - type: plugin
      #   path: ./cache.so
      #   name: Get

      - type: process
        cmd: >
          node
          --experimental-modules
          --no-warnings
          --experimental-vm-modules
          ./render.mjs
          --url=/{{url "url"}}
          --ip={{meta "ip"}}
          --user-agent='{{meta "ua"}}'
          --origin=https://jetsmarter.com/
          --src=https://jetsmarter.com/data/jscomv5/index.es.js
        # --src=https://d35qz7xn7nfid5.cloudfront.net/ssr/index.es.js
      # - type: process
      # cmd: 'echo {"status": {{q "status"}}, "content": "URL: {{url "url"}}, IP: {{meta "ip"}}, UA: {{meta "ua"}}"}'

      # - type: plugin
      #   path: ./cache.so
      #   name: Set

      - type: plugin
        path: ./ssr-Linux-x86_64.so
        name: JsonEntrypoint

  # Route
  - pattern: "/cleanthisbitch"
    pipeline:

      - type: process
        cmd: rm -rf ./cache

  # Route
  # AWS ECS ping
  - pattern: "/ping"
    pipeline:

      - type: process
        cmd: echo pong

  # Serve static data
  # - pattern: "/data/{url:*}"
  #   pipeline:

  #     - type: process
  #       cmd: cat ./cache/{{url "url"}}
